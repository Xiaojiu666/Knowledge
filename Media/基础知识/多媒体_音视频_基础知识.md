## 图像知识

#### 表示形式和大小:

任何一个图像都可以由RGB组成，常用的表示方式有以下几种。

- 浮点表示：取值范围为0.0～1.0，比如，在OpenGL ES中对每一个子 像素点的表示使用的就是这种表达方式。

- 整数表示：取值范围为0～255或者00～FF，8个比特表示一个子像 素，32个比特表示一个像素，这就是类似于某些平台上表示图像格式的 RGBA_8888数据格式。比如，Android平台上RGB_565的表示方法为16比 特模式表示一个像素，R用5个比特来表示，G用6个比特来表示，B用5个 比特来表示。

对于一幅图像，一般使用整数表示方法来进行描述，比如计算一张 1280×720的RGBA_8888图像的大小，可采用如下方式：

​			1280 * 720 * 4 = 3.516MB



#### 图像格式:

###### YUV：

###### RGB：



##	压缩知识

#### 图像压缩算法：

###### JPEG图像压缩：

上面计算方式是位图（bitmap）在内存中所占用的大小，所以每一张图像的裸数据都是很大的。对于图像的裸数据来讲，直接在网络上进行传输也是 不太可能的，所以就有了图像的压缩格式，比如JPEG压缩：JPEG是静态 图像压缩标准，由ISO制定。JPEG图像压缩算法在提供良好的压缩性能 的同时，具有较好的重建质量。这种算法被广泛应用于图像处理领域，当 然其也是一种有损压缩。

###### MPEG视频压缩:



#### 视频压缩算法

视频压缩算法，在编/解码过程中，将视频中每一帧通过算法进行压缩： YUV原始体量太大，无论对网络还是硬盘要求过大，

###### MPEG:

MPEG（1/2/3/4）系列由MPEG（Moving Picture Experts Group, ISO旗下的组织）主导。

对于视频，ISO同样也 制定了标准：Motion JPEG即MPEG，MPEG算法是适用于动态视频的压缩 算法，它除了对单幅图像进行编码外，还利用图像序列中的相关原则去 除冗余，这样可以大大提高视频的压缩比。截至目前，MPEG的版本一直 在不断更新中，主要包括这样几个版本：Mpeg1（用于VCD）、Mpeg2（用于 DVD）、Mpeg4 AVC（现在流媒体使用最多的就是它了）。

###### H264:

联合制定的编码标准，那就是现在主流的编码格式H264，当然还有下一代更先进的压缩编码标准H265。

H.264创造了多参考帧、多块类型、整数变换、帧内预测等新的压缩技术，使用了更精细的分像素运动矢量（1/4、1/8）和新一代的环路滤波器，

这使得压缩性能得到大大提高，系统也变得更加完善。



#### 编码概念

###### 视频帧

视频是由一帧一帧画面构成的，但是在视频的数据中，并不是真正按照一帧一帧原始数据保存下来的（如果这样，压缩编码就没有意义了）。

视频压缩中，每帧都代表着一幅静止的图像。而在进行实际压缩时， 会采取各种算法以减少数据的容量，其中IPB帧就是最常见的一种。

H264会根据一段时间内，画面的变化情况，选取一帧画面作为完整编码，下一帧只记录与上一帧完整数据的差别，是一个动态压缩的过程。

在H264中，三种类型的帧数据分别为:

- **I帧**：帧内编码帧（intra picture），也称关键帧，I帧通常是每个GOP（MPEG所使用的一种视频压缩技术）的第一个帧，经过适度地压缩，作为随机访问的参 考点，可以当成静态图像。I帧可以看作一个图像经过压缩后的产物，I帧压缩可以得到6：1的压缩比而不会产生任何可觉察的模糊现象。I帧压缩可去掉视频的空间冗余信息，下面即将介绍的P帧和B帧是为了去掉时间冗余信息。(空间维度)，你可以理解为这一帧画面的完整保留；解码时只需要本帧数据就可以完成（因为包含完整画面），视频第一帧永远是第I帧。

- **P帧**：帧间编码，前向预测编码帧。前向预测编码帧（predictive-frame），通过将图像序列中前面已 编码帧的时间冗余信息充分去除来压缩传输数据量的编码图像，也称为 预测帧。 (时间维度)，P帧表示的是这一帧跟之前的一个关键帧（或P帧）的差别，解码时需要用之前缓存的画面叠加上本帧定义的差别，生成最终画面。（也就是差别帧，P帧没有完整画面数据，只有与前一帧的画面差别的数据）

- **B帧**：帧间编码，双向预测内插编码帧（bi-directional interpolated predictionframe），既考虑源图像序列前面的已编码帧，又顾及源图像序列后面的已 编码帧之间的时间冗余信息，来压缩传输数据量的编码图像，也称为双向预测帧。 (时间维度)B帧是双向差别帧，也就是B帧记录的是本帧与前后帧的差别（具体比较复杂，有4种情况，但我这样说简单些，有兴趣可以看看我上面提供的资料），换言之，要解码B帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的与本帧数据的叠加取得最终的画面。B帧压缩率高，但是解码时CPU会比较累~。

- **IDR帧：**IDR都是I帧，可以防止一帧解码出错，导致后面所有帧解码出错的问题。当解码器在解码到IDR的时候，会将之前的参考帧清空，重新开始一个新的序列，这样，即便前面一帧解码出现重大错误，也不会蔓延到后面的数据中。eg：在网络相机传输的过程中， 只用到了IDR帧和P帧，原因是如果I帧间隔过长，网络传输丢包时，会造成严重的黑屏/花屏等现象，使用IDR帧 会在下一个gop来临之前清除上帧内容。

  ![image-20210330185615818](/Users/edz/Library/Application Support/typora-user-images/image-20210330185615818.png)

  由于B帧双向参考，所以解码时和显示顺序会有出入，B帧会向前和后参考，如果后向没有压缩好图片，则等待，但是显示顺序不可能错乱(1.3.4.2)，所以会进行缓存，等待解码完成后显示顺序

###### 图像组

全称：Group of picture。指一组变化不大的视频帧。

GOP的第一帧成为关键帧：IDR

IDR都是I帧，可以防止一帧解码出错，导致后面所有帧解码出错的问题。当解码器在解码到IDR的时候，会将之前的参考帧清空，重新开始一个新的序列，这样，即便前面一帧解码出现重大错误，也不会蔓延到后面的数据中。

> 注：关键帧都是I帧，但是I帧不一定是关键帧



###### **DTS与PTS**

DTS全称：Decoding Time Stamp。标示读入内存中数据流在什么时候开始送入解码器中进行解码。也就是解码顺序的时间戳。

PTS全称：Presentation Time Stamp。解码阶段进行视频的同步和输出用于标示解码后的视频帧什么时候被显示出来。

> 在没有B帧的情况下，DTS和PTS的输出顺序是一样的，一旦存在B帧，PTS和DTS则会不同。





关于Anroid播放器的编解码，主要分为硬编码和软编码。

| 软编码 | CPU        | 通过FFmpeg     | 具有更好的适应性，但是占用了更多的CUP那就意味着很耗费性能，很耗电， |
| ------ | ---------- | -------------- | ------------------------------------------------------------ |
| 硬编码 | GPU/解码器 | 通过MediaCodec | 每个设备支持不同 |



##	视频播放知识

<img src="/Users/edz/Library/Application Support/typora-user-images/image-20210421172309615.png" alt="image-20210421172309615" style="zoom: 25%;" />



播放一个互联网上的视频文件，需要经过以下几个步骤：解协议，解封装，解码视音频，视音频同步。

播放本地文件则不需要解协议，为以下几个步骤：解封装，解码视音频，视音频同步。他们的过程如图所示。



####	解协议

将流媒体协议的数据，解析为标准的相应的封装格式数据。视音频在网络上传播的时候，常常采用各种流媒体协议，例如HTTP，RTMP，或是MMS等等。这些协议在传输视音频数据的同时，也会传输一些信令数据。这些信令数据包括对播放的控制（播放，暂停，停止），或者对网络状态的描述等。解协议的过程中会去除掉信令数据而只保留视音频数据。例如，采用RTMP协议传输的数据，经过解协议操作后，输出FLV格式的数据。



####	解封装

将输入的封装格式的数据，分离成为音频流压缩编码数据和视频流压缩编码数据。封装格式种类很多，例如MP4，MKV，RMVB，TS，FLV，AVI等等，它的作用就是将已经压缩编码的视频数据和音频数据按照一定的格式放到一起。例如，FLV格式的数据，经过解封装操作后，输出H.264编码的视频码流和AAC编码的音频码流。



#### 解码

将视频/音频压缩编码数据，解码成为非压缩的视频/音频原始数据。音频的压缩编码标准包含AAC，MP3，AC-3等等，视频的压缩编码标准则包含H.264，MPEG2，VC-1等等。解码是整个系统中最重要也是最复杂的一个环节。通过解码，压缩编码的视频数据输出成为非压缩的颜色数据，例如YUV420P，RGB等等；压缩编码的音频数据输出成为非压缩的音频抽样数据，例如PCM数据。



####	音视频同步

根据解封装模块处理过程中获取到的参数信息，同步解码出来的视频和音频数据，并将视频音频数据送至系统的显卡和声卡播放出来。


参考资料:

- [Android 音视频开发打怪升级](https://www.jianshu.com/p/1749d2d43ecb)
- https://www.jianshu.com/p/e9a5e1fe2ad8
- https://blog.csdn.net/leixiaohua1020
- [雷神博客](https://www.jianshu.com/p/f5a1c9318524)
- [视频传输协议详解](https://www.jianshu.com/p/c04d810b7562)
- [免费MP4下载](https://wedistill.io/videos)
